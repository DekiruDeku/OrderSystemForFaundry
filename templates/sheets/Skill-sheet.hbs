<form class="{{cssClass}} skill os-item-form" autocomplete="off">
  <header class="sheet-header os-item-header">
    <img class="os-item-img" src="{{item.img}}" data-edit="img" title="{{item.name}}" />

    <div class="os-item-headmeta">
      <h1 class="os-item-title">
        <input name="name" type="text" value="{{item.name}}" placeholder="{{ localize 'Name' }}" />
      </h1>
      <div class="os-item-subtitle">{{#if data.isPerk}}Перк{{else}}Способность{{/if}}</div>
    </div>
  </header>

  <div class="os-item-body os-item-grid os-item-grid--skill">
    <!-- LEFT: main fields -->
    <div class="os-col">
      <section class="os-panel os-panel--pad">
        <div class="os-panel-title-row">
          <h3 class="os-panel-title">Основное</h3>
          <div class="os-inline">
            {{#unless data.isRacial}}
            <button type="button" class="train-item-sheet os-small-btn" title="Тренировка">
              <i class="fas fa-book"></i> Тренировка
            </button>
            {{/unless}}
            <button type="button" class="add-field os-small-btn">+ Поле</button>
          </div>
        </div>

        <table class="fields-table os-fields-table">
          <tbody>
            {{#unless data.hiddenDefaults.Circle}}
            <tr>
              <th class="field-label {{#if (lookup data.displayFields 'Circle')}}selected{{/if}}" data-field="Circle">Круг</th>
              <td><input type="text" inputmode="numeric" name="data.Circle" value="{{data.Circle}}" data-dtype="Number" min="0" max="12" /></td>
            </tr>
            {{/unless}}

            {{#unless data.hiddenDefaults.Level}}
            <tr>
              <th class="field-label {{#if (lookup data.displayFields 'Level')}}selected{{/if}}" data-field="Level">Уровень</th>
              <td><input type="text" inputmode="numeric" name="data.Level" value="{{data.Level}}" data-dtype="Number" min="0" /></td>
            </tr>
            {{/unless}}

            {{#unless data.hiddenDefaults.RangeFormula}}
            <tr>
              <th class="field-label {{#if (lookup data.displayFields 'RangeFormula')}}selected{{/if}}" data-field="RangeFormula">Формула дальности</th>
              <td>
                <input type="text" name="data.RangeFormula" value="{{data.RangeFormula}}" placeholder="например: 3 + Magic" />
                <div style="font-size:12px; opacity:0.8; margin-top:4px;">
                  Формат: <code>число + характеристика * множитель</code>. Поддерживаются RU/EN названия характеристик.
                </div>
              </td>
            </tr>
            {{/unless}}

            {{#unless data.hiddenDefaults.Range}}
            <tr>
              <th class="field-label {{#if (lookup data.displayFields 'Range')}}selected{{/if}}" data-field="Range">Дальность</th>
              <td><input type="text" inputmode="numeric" name="data.Range" value="{{data.Range}}" data-dtype="Number" min="0" readonly /></td>
            </tr>
            {{/unless}}

            {{#unless data.hiddenDefaults.RollFormulas}}
            <tr>
              <th class="field-label {{#if (lookup data.displayFields 'RollFormulas')}}selected{{/if}}" data-field="RollFormulas">Формулы броска</th>
              <td>
                <div>
                  {{#if data.RollFormulas.length}}
                    {{#each data.RollFormulas as |f idx|}}
                      <div class="os-inline" style="gap:6px; margin-bottom:6px;">
                        <input
                          type="text"
                          class="roll-formula-value"
                          data-index="{{idx}}"
                          name="data.RollFormulas.{{idx}}"
                          value="{{f}}"
                          placeholder="например: Magic + 2"
                        />
                        <button type="button" class="roll-formula-remove os-small-btn" data-index="{{idx}}">Удалить</button>
                      </div>
                    {{/each}}
                  {{else}}
                    <div class="os-empty">Нет формул</div>
                  {{/if}}
                  <button type="button" class="roll-formula-add os-small-btn">+ Формула</button>
                  <div style="font-size:12px; opacity:0.8; margin-top:4px;">
                    Формулы прибавляются к выбранному игроком броску. Если формула не указана — бросок только кубом. Поддерживаются RU/EN названия характеристик.
                  </div>
                </div>
              </td>
            </tr>
            {{/unless}}

            {{#unless data.hiddenDefaults.DamageFormula}}
          <tr>
          <th class="field-label {{#if (lookup data.displayFields 'DamageFormula')}}selected{{/if}}" data-field="DamageFormula">Формула воздействия</th>
            <td>
              <input type="text" name="data.DamageFormula" value="{{data.DamageFormula}}"
                placeholder="например: 5 + Strength * 2" />
              <div style="font-size:12px; opacity:0.8; margin-top:4px;">
                Формат: <code>число + характеристика * множитель</code>. Поддерживаются RU/EN названия характеристик.
              </div>
            </td>
          </tr>
            {{/unless}}
            {{#unless data.hiddenDefaults.Damage}}
            <tr>
              <th class="field-label {{#if (lookup data.displayFields 'Damage')}}selected{{/if}}" data-field="Damage">Воздействие</th>
              <td>
                <div style="display:flex; gap:8px; align-items:center;">
                  <select name="data.DamageMode" data-type="String" style="max-width:140px;">
                    <option value="damage" {{isSelected data.DamageMode "damage"}}>Урон</option>
                    <option value="heal" {{isSelected data.DamageMode "heal"}}>Лечение</option>
                  </select>
                  <input type="text" inputmode="numeric" name="data.Damage" value="{{data.Damage}}" data-dtype="Number" min="0"
              readonly />
                </div>
              </td>
            </tr>
            {{/unless}}

            {{#unless data.hiddenDefaults.Multiplier}}
            <tr>
              <th class="field-label {{#if (lookup data.displayFields 'Multiplier')}}selected{{/if}}" data-field="Multiplier">Множитель</th>
              <td><input type="text" inputmode="numeric" name="data.Multiplier" value="{{data.Multiplier}}" data-dtype="Number" min="0" step="0.1" /></td>
            </tr>
            {{/unless}}

            {{#unless data.hiddenDefaults.UsageCost}}
            <tr>
              <th class="field-label {{#if (lookup data.displayFields 'UsageCost')}}selected{{/if}}" data-field="UsageCost">Стоимость применения</th>
              <td><input type="text" inputmode="numeric" name="data.UsageCost" value="{{data.UsageCost}}" data-dtype="Number" placeholder="например: 2" /></td>
            </tr>
            {{/unless}}

            {{#unless data.hiddenDefaults.ActionCost}}
            <tr>
              <th class="field-label {{#if (lookup data.displayFields 'ActionCost')}}selected{{/if}}" data-field="ActionCost">Стоимость действий</th>
              <td><input type="text" name="data.ActionCost" value="{{data.ActionCost}}" placeholder="например: 1 действие" /></td>
            </tr>
            {{/unless}}

            {{#unless data.hiddenDefaults.Cooldown}}
            <tr>
              <th class="field-label {{#if (lookup data.displayFields 'Cooldown')}}selected{{/if}}" data-field="Cooldown">Перезарядка</th>
              <td><input type="text" inputmode="numeric" name="data.Cooldown" value="{{data.Cooldown}}" data-dtype="Number" min="0" /></td>
            </tr>
            {{/unless}}

            {{#unless data.hiddenDefaults.Description}}
            <tr>
              <th class="field-label {{#if (lookup data.displayFields 'Description')}}selected{{/if}}" data-field="Description">Описание</th>
              <td><textarea name="data.Description">{{data.Description}}</textarea></td>
            </tr>
            {{/unless}}

            {{#unless data.hiddenDefaults.Effects}}
            <tr>
              <th class="field-label {{#if (lookup data.displayFields 'Effects')}}selected{{/if}}" data-field="Effects">Эффекты</th>
              <td><textarea name="data.Effects">{{data.Effects}}</textarea></td>
            </tr>
            {{/unless}}

            {{#each data.additionalFields as |field index|}}
            {{#unless field.hidden}}
            <tr>
              <th class="field-label {{#if field.show}}selected{{/if}}" data-type="additional" data-index="{{index}}">{{field.name}}</th>
              <td>
                <input
                  type="text"
                  class="additional-field-value"
                  data-index="{{index}}"
                  name="data.additionalFields.{{index}}.value"
                  value="{{field.value}}"
                />
              </td>
            </tr>
            {{/unless}}
            {{/each}}
          </tbody>
        </table>

        <div class="os-help os-mt-6">
          Клик по названию поля переключает его видимость на листе персонажа. Если вписать в значение <b>-</b>, поле скрывается (его можно вернуть через кнопку <b>+ Поле</b>).
        </div>
      </section>

      {{#if data.isPerk}}
      <section class="os-panel os-panel--pad os-mt-10">
        <div class="os-panel-title-row">
          <h3 class="os-panel-title">Бонусы перка</h3>
          <button type="button" class="perk-bonus-add os-small-btn">+ Бонус</button>
        </div>

        <div class="os-help os-mt-6">
          Кубик на миниатюре перка показывается, если у перка есть хотя бы одна формула броска (RollFormulas / RollFormula).
        </div>

        <div class="os-inline os-mt-6" style="gap:10px; align-items:center;">
          <label style="min-width:260px;">О.О для получения перка (уровень 0)</label>
          <input type="number" name="data.perkTrainingPoints" value="{{data.perkTrainingPoints}}" data-dtype="Number" min="0" step="1" style="max-width:90px;" />
        </div>

        <div class="os-help os-mt-6">
          Это значение используется только для перков: оно заменяет количество очков обучения на уровне 0 (для любого круга).
        </div>

<table class="os-fields-table perk-bonus-table">
          <thead>
            <tr>
              <th style="width: 70%;">Параметр</th>
              <th style="width: 20%;">Значение</th>
              <th style="width: 10%;"></th>
            </tr>
          </thead>
          <tbody>
            {{#each data.perkBonuses as |b index|}}
            <tr>
              <td>
                <select class="perk-bonus-target" data-index="{{index}}">
                  {{#each ../perkBonusTargets as |t|}}
                    <option value="{{t.value}}" {{isSelected t.value b.target}}>{{t.label}}</option>
                  {{/each}}
                </select>
              </td>
              <td>
                <input type="number" class="perk-bonus-value" data-index="{{index}}" value="{{b.value}}" data-dtype="Number" />
              </td>
              <td>
                <button type="button" class="perk-bonus-remove os-icon-btn" data-index="{{index}}">✕</button>
              </td>
            </tr>
            {{/each}}
          </tbody>
        </table>

        <div class="os-help os-mt-6">
          Эти бонусы автоматически применяются к персонажу, когда перк находится у него в предметах.
        </div>
      </section>
      {{/if}}
    </div>

    <!-- RIGHT: progress + delivery -->
    <div class="os-col">
      {{#unless data.isRacial}}
      <section class="os-panel os-panel--pad os-skill-circle-panel">
        <h3 class="os-panel-title">Прогресс навыка</h3>
        <div class="os-center">
          <canvas
            class="circle-progress-skill"
            data-circle="{{data.Circle}}"
            data-level="{{data.Level}}"
            data-filled="{{data.filledSegments}}"
          ></canvas>
        </div>
      </section>
      {{/unless}}

      <section class="os-panel os-panel--pad">
        <h3 class="os-panel-title">Подробности</h3>

        <div class="os-form-grid">
          {{#unless data.hiddenDefaults.DeliveryType}}
          <div class="os-form-row">
            <label class="field-label {{#if (lookup data.displayFields 'DeliveryType')}}selected{{/if}}" data-field="DeliveryType">Тип применения</label>
            <select name="data.DeliveryType" class="skill-delivery-select" data-type="String">
              {{#each skillDeliveryTypes as |opt|}}
                <option value="{{opt.value}}" {{isSelected opt.value ../data.DeliveryType}}>{{opt.label}}</option>
              {{/each}}
            </select>
          </div>
          {{/unless}}

          <!-- SAVE CHECK -->
          {{#unless data.hiddenDefaults.SaveAbility}}
          <div class="os-form-row skill-delivery-row skill-delivery-save">
            <label class="field-label {{#if (lookup data.displayFields 'SaveAbility')}}selected{{/if}}" data-field="SaveAbility">Проверка цели (характеристика)</label>
            <select name="data.SaveAbility" data-type="String">
              <option value="" {{isSelected "" data.SaveAbility}}>—</option>
              {{#each characteristics as |c|}}
                <option value="{{c}}" {{isSelected c ../data.SaveAbility}}>{{localize c}}</option>
              {{/each}}
            </select>
          </div>
          {{/unless}}

          {{#unless data.hiddenDefaults.SaveDCFormula}}
          <div class="os-form-row skill-delivery-row skill-delivery-save">
            <label class="field-label {{#if (lookup data.displayFields 'SaveDCFormula')}}selected{{/if}}" data-field="SaveDCFormula">Сложность проверки (КС)</label>
            <input name="data.SaveDCFormula" type="text" value="{{data.SaveDCFormula}}" placeholder="например: 10 + Магия" />
          </div>
          {{/unless}}

          <!-- AOE / TEMPLATE -->
          <div class="skill-delivery-row skill-delivery-aoe">
            <div class="os-subtitle">Область / Шаблон</div>
            <div class="os-form-grid os-form-grid--compact">
              {{#unless data.hiddenDefaults.AreaShape}}
              <div class="os-form-row">
                <label class="field-label {{#if (lookup data.displayFields 'AreaShape')}}selected{{/if}}" data-field="AreaShape">Форма</label>
                <select name="data.AreaShape" data-type="String">
                  {{#each areaShapeTypes as |opt|}}
                    <option value="{{opt.value}}" {{isSelected opt.value ../data.AreaShape}}>{{opt.label}}</option>
                  {{/each}}
                </select>
              </div>
              {{/unless}}

              {{#unless data.hiddenDefaults.AreaSize}}
              <div class="os-form-row">
                <label class="field-label {{#if (lookup data.displayFields 'AreaSize')}}selected{{/if}}" data-field="AreaSize">Размер</label>
                <input name="data.AreaSize" type="text" inputmode="numeric" value="{{data.AreaSize}}" data-dtype="Number" min="0" step="0.5" />
              </div>
              {{/unless}}

              {{#unless data.hiddenDefaults.AreaWidth}}
              <div class="os-form-row">
                <label class="field-label {{#if (lookup data.displayFields 'AreaWidth')}}selected{{/if}}" data-field="AreaWidth">Ширина</label>
                <input name="data.AreaWidth" type="text" inputmode="numeric" value="{{data.AreaWidth}}" data-dtype="Number" min="0" step="0.5" />
              </div>
              {{/unless}}

              {{#unless data.hiddenDefaults.AreaAngle}}
              <div class="os-form-row">
                <label class="field-label {{#if (lookup data.displayFields 'AreaAngle')}}selected{{/if}}" data-field="AreaAngle">Угол</label>
                <input name="data.AreaAngle" type="text" inputmode="numeric" value="{{data.AreaAngle}}" data-dtype="Number" min="0" step="1" />
              </div>
              {{/unless}}

              {{#unless data.hiddenDefaults.AreaPersistent}}
              <div class="os-form-row">
                <label class="field-label {{#if (lookup data.displayFields 'AreaPersistent')}}selected{{/if}}" data-field="AreaPersistent">Постоянная</label>
                <input name="data.AreaPersistent" type="checkbox" {{#if data.AreaPersistent}}checked{{/if}} />
              </div>
              {{/unless}}

              <div class="os-form-row os-form-row--wide">
                <label class="field-label {{#if (lookup data.displayFields 'AreaColor')}}selected{{/if}}" data-field="AreaColor">Цвет</label>
                <div class="os-inline">
                  <select class="skill-area-color-preset">
                    <option value="" {{#unless data.AreaColor}}selected{{/unless}}>— цвет игрока —</option>
                    <option value="#e6194B" {{isSelected "#e6194B" data.AreaColor}}>Красный</option>
                    <option value="#3cb44b" {{isSelected "#3cb44b" data.AreaColor}}>Зелёный</option>
                    <option value="#4363d8" {{isSelected "#4363d8" data.AreaColor}}>Синий</option>
                    <option value="#f58231" {{isSelected "#f58231" data.AreaColor}}>Оранжевый</option>
                    <option value="#911eb4" {{isSelected "#911eb4" data.AreaColor}}>Фиолетовый</option>
                    <option value="#42d4f4" {{isSelected "#42d4f4" data.AreaColor}}>Голубой</option>
                    <option value="#f032e6" {{isSelected "#f032e6" data.AreaColor}}>Розовый</option>
                    <option value="#ffe119" {{isSelected "#ffe119" data.AreaColor}}>Жёлтый</option>
                    <option value="#ffffff" {{isSelected "#ffffff" data.AreaColor}}>Белый</option>
                    <option value="#000000" {{isSelected "#000000" data.AreaColor}}>Чёрный</option>
                    <option value="__custom__" {{#if data.AreaColor}}{{#unless (isPresetColor data.AreaColor)}}selected{{/unless}}{{/if}}>Свой</option>
                  </select>
                  <input class="skill-area-color-input" type="color" value="{{#if data.AreaColor}}{{data.AreaColor}}{{else}}{{userColor}}{{/if}}" />
                  <input type="hidden" name="data.AreaColor" value="{{data.AreaColor}}" />
                </div>
                <div class="os-help os-mt-2">Пустое значение = цвет текущего игрока при применении.</div>
              </div>
            </div>
          </div>
        </div>

        <div class="os-help os-mt-6">
          Тип применения управляет дополнительными блоками ниже. Секции скрываются автоматически.
        </div>
      </section>

    </div>
  </div>
</form>
