<form class="{{cssClass}} weapon os-item-form {{#unless osCanEdit}}os-edit-locked{{/unless}}" autocomplete="off">
  <header class="sheet-header os-item-header">
    <img class="os-item-img" src="{{item.img}}" data-edit="img" title="{{item.name}}" />

    <div class="os-item-headmeta">
      <h1 class="os-item-title">
        <input name="name" type="text" value="{{item.name}}" placeholder="{{ localize 'Name' }}" />
      </h1>

      <div class="os-item-headrow">
        <label class="os-check">
          <input type="checkbox" name="data.inHand" {{#if data.inHand}}checked{{/if}} class="in-hand-checkbox" />
          <span>В руке</span>
        </label>

        <button type="button" class="reload-rangeweapon os-small-btn">Перезарядить</button>
      </div>
    </div>
  </header>

  <div class="os-item-body os-item-grid">
    <!-- LEFT COLUMN -->
    <div class="os-col">
      <section class="os-panel os-panel--pad">
        <h3 class="os-panel-title">Описание</h3>
        <textarea name="data.description" class="os-textarea">{{data.description}}</textarea>
      </section>

      <section class="os-panel os-panel--pad">
        <h3 class="os-panel-title">Основные параметры</h3>
        <div class="os-form-grid">
          <div class="os-field">
            <label class="field-label {{#if (shouldDisplayField data.displayFields 'DamageFormula')}}selected{{/if}}" data-field="DamageFormula">Формула урона</label>
            <input name="data.DamageFormula" type="text" value="{{data.DamageFormula}}" placeholder="например: 5 + Strength * 2" />
          </div>

          <div class="os-field">
            <label class="field-label {{#if (shouldDisplayField data.displayFields 'Damage')}}selected{{/if}}" data-field="Damage">Урон</label>
            <input name="data.Damage" type="text" value="{{data.Damage}}" data-type="Number" readonly />
          </div>

          <div class="os-field">
              <label class="field-label {{#if (shouldDisplayField data.displayFields 'Rateoffire')}}selected{{/if}}" data-field="Rateoffire">Скорострельность</label>            <input name="data.Rateoffire" type="text" value="{{data.Rateoffire}}" data-type="Number" />
          </div>

          <div class="os-magazine-row">
            <div class="os-field">
              <label class="field-label {{#if (shouldDisplayField data.displayFields 'Magazine')}}selected{{/if}}" data-field="Magazine">Магазин</label>
              <input name="data.Magazine" type="text" value="{{data.Magazine}}" data-type="Number" />
            </div>
            <div class="os-field">
              <label class="field-label {{#if (shouldDisplayField data.displayFields 'MagazineSize')}}selected{{/if}}" data-field="MagazineSize">Размер магазина</label>
              <input name="data.MagazineSize" type="text" value="{{data.MagazineSize}}" data-type="Number" />
            </div>
          </div>

          <div class="os-field">
              <label class="field-label {{#if (shouldDisplayField data.displayFields 'Effectivefiringrange')}}selected{{/if}}" data-field="Effectivefiringrange">Эффективная дальность</label>            <input name="data.Effectivefiringrange" type="text" value="{{data.Effectivefiringrange}}" data-type="Number" />
          </div>

          <div class="os-field">
              <label class="field-label {{#if (shouldDisplayField data.displayFields 'Maximumfiringrange')}}selected{{/if}}" data-field="Maximumfiringrange">Макс. дальность</label>            <input name="data.Maximumfiringrange" type="text" value="{{data.Maximumfiringrange}}" data-type="Number" />
          </div>

          <div class="os-field">
            <label>Слоты модификации</label>
            <input name="data.Modificationslots" type="text" value="{{data.Modificationslots}}" data-type="Number" />
          </div>

          <div class="os-field">
              <label class="field-label {{#if (shouldDisplayField data.displayFields 'Durability')}}selected{{/if}}" data-field="Durability">Прочность</label>
            <input name="data.Durability" type="text" value="{{data.Durability}}" data-type="Number" />
          </div>

          <div class="os-field">
              <label class="field-label {{#if (shouldDisplayField data.displayFields 'EffectThreshold')}}selected{{/if}}" data-field="EffectThreshold">Порог эффекта</label>
            <input name="data.EffectThreshold" type="text" value="{{data.EffectThreshold}}" data-type="Number" />
          </div>
        </div>
      </section>

      <section class="os-panel os-panel--pad">
        <h3 class="os-panel-title">Слоты снаряжения</h3>
        <select id="weapon-type" name="data.weaponType" class="weapon-type" data-type="String">
<option value="Основное оружие" {{isSelected data.weaponType "Основное оружие"}}>Основное оружие</option>
<option value="Вторичное оружие" {{isSelected data.weaponType "Вторичное оружие"}}>Вторичное оружие</option>
{{#if (isWeaponSlot data.weaponType "melee")}}
  <option value="Холодное оружие" selected disabled>Холодное оружие (недоступно для дальнего)</option>
{{/if}}
        </select>
      </section>
    </div>

    <!-- RIGHT COLUMN -->
    <div class="os-col">
      <section class="os-panel os-panel--pad">
        <div class="os-panel-title-row advantage-field">
          <h3 class="os-panel-title">Параметры</h3>
          {{#if osCanEdit}}<button type="button" class="modify-advantage-button os-small-btn">+ Параметр</button>{{/if}}
        </div>

        <div class="additional-advantages os-pill-list">
          {{#each data.additionalAdvantages as |curAd index| }}
            <div class="advantage-char os-pill" data-index="{{index}}">
              <span class="os-pill-text">{{localize curAd.Characteristic}} {{curAd.Value}}</span>
              {{#if @root.osCanEdit}}<a type="button" class="advantage-remove-characteristic os-pill-action">❌</a>{{/if}}
            </div>
          {{/each}}
          {{#unless data.additionalAdvantages.length}}
            <div class="os-empty">Нет параметров</div>
          {{/unless}}
        </div>
      </section>

      <section class="os-panel os-panel--pad">
        <div class="os-panel-title-row requires-field">
          <h3 class="os-panel-title">Требования</h3>
          {{#if osCanEdit}}<button type="button" class="modify-require-button os-small-btn">+ Требование</button>{{/if}}
        </div>

        <div class="requires-array os-pill-list">
          {{#each data.RequiresArray as |curRq index| }}
            <div class="requires-char os-pill" data-index="{{index}}">
              <span class="os-pill-text">{{formatRequirement curRq}}</span>
              {{#if @root.osCanEdit}}<a type="button" class="requires-remove-characteristic os-pill-action">❌</a>{{/if}}
            </div>
          {{/each}}
          {{#unless data.RequiresArray.length}}
            <div class="os-empty">Нет требований</div>
          {{/unless}}
        </div>
      </section>

      <section class="os-panel os-panel--pad">
        <h3 class="os-panel-title">Модификации</h3>
        <div class="os-help">Занято слотов: {{modificationCount}} / {{modificationSlots}}</div>
        {{#if modificationHasOverflow}}
          <div class="os-help os-help--warn">Лимит превышен на {{modificationOverflow}}</div>
        {{/if}}

        {{#if osCanEdit}}
          <div class="drop-area modifications-drop-area">
            <p class="os-help">Перетащите сюда предмет типа "Regular Item"</p>
          </div>
        {{/if}}

        <div class="modifications-list os-list">
          {{#each modifications as |mod|}}
            <div class="modification-row os-row" data-modification-id="{{mod.id}}">
              <div class="modification-main">
                <img class="modification-img" src="{{mod.img}}" alt="{{mod.name}}" />
                <a class="modification-open" data-modification-id="{{mod.id}}">{{mod.name}}</a>
                {{#if mod.missing}}
                  <span class="modification-missing">(недоступно)</span>
                {{/if}}
              </div>
              {{#if @root.osCanEdit}}<button type="button" class="modification-remove os-small-btn" data-modification-id="{{mod.id}}">Удалить</button>{{/if}}
            </div>
          {{/each}}
          {{#unless modifications.length}}
            <div class="os-empty">Нет модификаций</div>
          {{/unless}}
        </div>
      </section>

      <section class="os-panel os-panel--pad">
        <div class="os-panel-title-row">
          <h3 class="os-panel-title">Характеристики атаки</h3>
          {{#if osCanEdit}}<button type="button" class="open-attack-dialog os-small-btn">Настроить</button>{{/if}}
        </div>

        <div class="attack-characteristics-array os-pill-list">
          {{#each data.AttackCharacteristics as |char index| }}
            <div class="attack-char os-pill" data-index="{{index}}">
              <span class="os-pill-text">{{localize char}}</span>
              {{#if @root.osCanEdit}}<a type="button" class="remove-attack-characteristic os-pill-action">❌</a>{{/if}}
            </div>
          {{/each}}
          {{#unless data.AttackCharacteristics.length}}
            <div class="os-empty">Не выбрано</div>
          {{/unless}}
        </div>
      </section>

      {{#if hasMassAttackTag}}
      <section class="os-panel os-panel--pad">
        <h3 class="os-panel-title">Массовая атака (шаблон)</h3>
        <div class="os-form-grid">
          <div class="os-field">
            <label>Форма</label>
            <select name="data.AoEShape" data-type="String">
              {{#each weaponAoeShapeTypes as |opt|}}
                <option value="{{opt.value}}" {{isSelected ../data.AoEShape opt.value}}>{{opt.label}}</option>
              {{/each}}
            </select>
          </div>

          <div class="os-field">
            <label>Размер</label>
            <input name="data.AoESize" type="text" value="{{data.AoESize}}" data-type="Number" />
            <div class="os-help">0 = нет массовой атаки</div>
          </div>

          <div class="os-field">
            <label>Ширина</label>
            <input name="data.AoEWidth" type="text" value="{{data.AoEWidth}}" data-type="Number" />
            <div class="os-help">Для линии/прямоугольника</div>
          </div>

          <div class="os-field">
            <label>Угол</label>
            <input name="data.AoEAngle" type="text" value="{{data.AoEAngle}}" data-type="Number" />
            <div class="os-help">Для конуса</div>
          </div>

          <div class="os-field">
            <label>Цвет</label>
            <input name="data.AoEColor" type="text" value="{{data.AoEColor}}" data-type="String" placeholder="#ffffff (пусто = цвет игрока)" />
          </div>
        </div>
      </section>
      {{/if}}

      <section class="os-panel os-panel--pad">
        <div class="os-panel-title-row">
            <h3 class="os-panel-title field-label {{#if (shouldDisplayField data.displayFields 'OnHitEffects')}}selected{{/if}}" data-field="OnHitEffects">Эффекты при попадании</h3>
          {{#if osCanEdit}}<button type="button" class="add-weapon-effect os-small-btn">+ Эффект</button>{{/if}}
        </div>

        <div class="weapon-effects-list os-list">
          {{#each data.OnHitEffects as |effect index| }}
            <div class="weapon-effect-row os-row" data-index="{{index}}" style="gap:8px; align-items:center;">
              <select name="data.OnHitEffects.{{index}}.debuffKey" class="os-select" style="flex:1; min-width:180px;">
                <option value="">— выберите дебафф —</option>
                {{#each ../debuffOptions as |opt|}}
                  <option value="{{opt.key}}" {{isSelected opt.key effect.debuffKey}}>{{opt.label}}</option>
                {{/each}}
              </select>

              <select name="data.OnHitEffects.{{index}}.stateKey" class="os-select" style="width:88px;">
                <option value="1" {{isSelected effect.stateKey "1"}}>1</option>
                <option value="2" {{isSelected effect.stateKey "2"}}>2</option>
                <option value="3" {{isSelected effect.stateKey "3"}}>3</option>
              </select>

              {{#if @root.osCanEdit}}<button type="button" class="remove-weapon-effect os-small-btn" data-index="{{index}}">Удалить</button>{{/if}}
            </div>
          {{/each}}
          {{#unless data.OnHitEffects.length}}
            <div class="os-empty">Нет эффектов</div>
          {{/unless}}
        </div>
      </section>
              <section class="os-panel os-panel--pad">
        <h3 class="os-panel-title">Теги оружия</h3>
        <div class="order-tags">
          {{#if osCanEdit}}
            <div class="os-tag-row">
              <input class="order-tag-input" type="text" placeholder="добавить тег..." />
              <button type="button" class="tag-add os-small-btn">+</button>
              <select class="order-tag-select">
                <option value="">- выберите тег -</option>
                {{#each weaponTagOptions as |tagOpt|}}
                  <option value="{{tagOpt.key}}">{{tagOpt.label}}</option>
                {{/each}}
              </select>
              <button type="button" class="tag-add-select os-small-btn">+</button>
            </div>
          {{/if}}

            <div class="order-tag-list">
            {{#each data.tags as |tag index|}}
              <span class="order-tag-pill"
              data-tooltip="{{#if (orderTagDescription tag)}}{{orderTagDescription tag}}{{else}}Нет описания{{/if}}"
              data-tooltip-direction="UP">
            {{orderTagLabel tag}}
            {{#if @root.osCanEdit}}<a type="button" class="tag-remove" data-index="{{index}}" data-tag="{{tag}}">×</a>{{/if}}
            </span>
            {{/each}}

          {{#unless data.tags.length}}
          <div class="os-empty">Нет тегов</div>
          {{/unless}}
    </div>
  </div>
</section>
    </div>
  </div>
</form>
