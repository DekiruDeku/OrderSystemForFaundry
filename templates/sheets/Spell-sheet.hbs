<form class="{{cssClass}} spell os-item-form" autocomplete="off">
  <header class="sheet-header os-item-header">
    <img class="os-item-img" src="{{item.img}}" data-edit="img" title="{{item.name}}" />

    <div class="os-item-headmeta">
      <h1 class="os-item-title">
        <input name="name" type="text" value="{{item.name}}" placeholder="{{ localize 'Name' }}" />
      </h1>
      <div class="os-item-subtitle">Заклинание</div>
    </div>
  </header>

  <!-- Variant B: right = Details (Delivery / Summon / AoE), effects = bottom -->
  <div class="os-item-body os-item-grid os-item-grid--spell">
    <!-- LEFT COLUMN: main fields -->
    <div class="os-col">
      <section class="os-panel os-panel--pad">
        <div class="os-panel-title-row">
          <h3 class="os-panel-title">Основное</h3>
          <button type="button" class="add-field os-small-btn">+ Поле</button>
        </div>

        <table class="fields-table os-fields-table">
          <tbody>
            {{#unless data.hiddenDefaults.Circle}}
            <tr>
              <th class="field-label {{#if (lookup data.displayFields 'Circle')}}selected{{/if}}" data-field="Circle">Круг</th>
              <td><input type="number" name="data.Circle" value="{{data.Circle}}" data-dtype="Number" min="0" max="12" /></td>
            </tr>
            {{/unless}}

            {{#unless data.hiddenDefaults.Level}}
            <tr>
              <th class="field-label {{#if (lookup data.displayFields 'Level')}}selected{{/if}}" data-field="Level">Уровень</th>
              <td><input type="number" name="data.Level" value="{{data.Level}}" data-dtype="Number" min="0" /></td>
            </tr>
            {{/unless}}

            {{#unless data.hiddenDefaults.Damage}}
            <tr>
              <th class="field-label {{#if (lookup data.displayFields 'Damage')}}selected{{/if}}" data-field="Damage">Урон</th>
              <td><input type="number" name="data.Damage" value="{{data.Damage}}" data-dtype="Number" min="0" /></td>
            </tr>
            {{/unless}}

            {{#unless data.hiddenDefaults.Multiplier}}
            <tr>
              <th class="field-label {{#if (lookup data.displayFields 'Multiplier')}}selected{{/if}}" data-field="Multiplier">Множитель</th>
              <td><input type="number" name="data.Multiplier" value="{{data.Multiplier}}" data-dtype="Number" min="0" step="0.1" /></td>
            </tr>
            {{/unless}}

            {{#unless data.hiddenDefaults.Range}}
            <tr>
              <th class="field-label {#if (lookup data.displayFields 'Range')}selected{/if}" data-field="Range">Дистанция</th>
              <td><input type="number" name="data.Range" value="{{data.Range}}" data-dtype="Number" min="0" /></td>
            </tr>
            {{/unless}}

            {{#unless data.hiddenDefaults.Duration}}
            <tr>
              <th class="field-label {{#if (lookup data.displayFields 'Duration')}}selected{{/if}}" data-field="Duration">Длительность</th>
              <td><input type="text" name="data.Duration" value="{{data.Duration}}" /></td>
            </tr>
            {{/unless}}

            {{#unless data.hiddenDefaults.UsageCost}}
            <tr>
              <th class="field-label {{#if (lookup data.displayFields 'UsageCost')}}selected{{/if}}" data-field="UsageCost">Стоимость применения</th>
              <td><input type="number" name="data.UsageCost" value="{{data.UsageCost}}" data-dtype="Number" min="0" /></td>
            </tr>
            {{/unless}}

            {{#unless data.hiddenDefaults.UsageThreshold}}
            <tr>
              <th class="field-label {#if (lookup data.displayFields 'UsageThreshold')}selected{/if}" data-field="UsageThreshold">Порог условия</th>
              <td class="os-inline">
                <input type="number" name="data.UsageThreshold" value="{{data.UsageThreshold}}" data-dtype="Number" min="0" />
                <button type="button" class="set-threshold os-small-btn">…</button>
              </td>
            </tr>
            {{/unless}}

            <!-- Legacy / migration-driven fields (used by inference & cards) -->
            {{#unless data.hiddenDefaults.SpellType}}
            <tr>
              <th class="field-label {#if (lookup data.displayFields 'SpellType')}selected{/if}" data-field="SpellType">SpellType</th>
              <td>
                <select name="data.SpellType">
                  <option value="Damage" {{isSelected data.SpellType "Damage"}}>Damage</option>
                  <option value="Buff" {{isSelected data.SpellType "Buff"}}>Buff</option>
                  <option value="Debuff" {{isSelected data.SpellType "Debuff"}}>Debuff</option>
                  <option value="Utility" {{isSelected data.SpellType "Utility"}}>Utility</option>
                  <option value="Summon" {{isSelected data.SpellType "Summon"}}>Summon</option>
                </select>
              </td>
            </tr>
            {{/unless}}

            {{#unless data.hiddenDefaults.TriggerType}}
            <tr>
              <th class="field-label {#if (lookup data.displayFields 'TriggerType')}selected{/if}" data-field="TriggerType">TriggerType</th>
              <td><input type="text" name="data.TriggerType" value="{{data.TriggerType}}" /></td>
            </tr>
            {{/unless}}

            {{#unless data.hiddenDefaults.EnemyInteractionType}}
            <tr>
              <th class="field-label {#if (lookup data.displayFields 'EnemyInteractionType')}selected{/if}" data-field="EnemyInteractionType">EnemyInteraction</th>
              <td>
                <select name="data.EnemyInteractionType" class="spell-enemy-interaction">
                  {{#each enemyInteractionTypes as |opt|}}
                    <option value="{{opt.value}}" {{isSelected ../data.EnemyInteractionType opt.value}}>{{opt.label}}</option>
                  {{/each}}
                </select>
              </td>
            </tr>
            {{/unless}}

            {{#unless data.hiddenDefaults.DamageType}}
            <tr>
              <th class="field-label {#if (lookup data.displayFields 'DamageType')}selected{/if}" data-field="DamageType">DamageType</th>
              <td>
                <select name="data.DamageType">
                  <option value="" {{isSelected data.DamageType ""}}>—</option>
                  <option value="Physical" {{isSelected data.DamageType "Physical"}}>Physical</option>
                  <option value="Fire" {{isSelected data.DamageType "Fire"}}>Fire</option>
                  <option value="Ice" {{isSelected data.DamageType "Ice"}}>Ice</option>
                  <option value="Lightning" {{isSelected data.DamageType "Lightning"}}>Lightning</option>
                  <option value="Poison" {{isSelected data.DamageType "Poison"}}>Poison</option>
                  <option value="Radiant" {{isSelected data.DamageType "Radiant"}}>Radiant</option>
                  <option value="Necrotic" {{isSelected data.DamageType "Necrotic"}}>Necrotic</option>
                  <option value="Psychic" {{isSelected data.DamageType "Psychic"}}>Psychic</option>
                </select>
              </td>
            </tr>
            {{/unless}}

            {{#unless data.hiddenDefaults.DamageSubtype}}
            <tr>
              <th class="field-label {#if (lookup data.displayFields 'DamageSubtype')}selected{/if}" data-field="DamageSubtype">DamageSubtype</th>
              <td><input type="text" name="data.DamageSubtype" value="{{data.DamageSubtype}}" /></td>
            </tr>
            {{/unless}}

            {{#unless data.hiddenDefaults.EffectConditions}}
            <tr>
              <th class="field-label {#if (lookup data.displayFields 'EffectConditions')}selected{/if}" data-field="EffectConditions">Условия эффектов</th>
              <td><input type="text" name="data.EffectConditions" value="{{data.EffectConditions}}" /></td>
            </tr>
            {{/unless}}

            {{#unless data.hiddenDefaults.UsageConditions}}
            <tr>
              <th class="field-label {#if (lookup data.displayFields 'UsageConditions')}selected{/if}" data-field="UsageConditions">Условия применения</th>
              <td><input type="text" name="data.UsageConditions" value="{{data.UsageConditions}}" /></td>
            </tr>
            {{/unless}}

            <!-- Effects visibility toggle for actor tooltip (editor is below) -->
            <tr>
              <th class="field-label {{#if (lookup data.displayFields 'Effects')}}selected{{/if}}" data-field="Effects">Эффекты</th>
              <td class="os-field-note">Редактируются ниже</td>
            </tr>

            {{#unless data.hiddenDefaults.Description}}
            <tr>
              <th class="field-label {{#if (lookup data.displayFields 'Description')}}selected{{/if}}" data-field="Description">Описание</th>
              <td><textarea name="data.Description">{{data.Description}}</textarea></td>
            </tr>
            {{/unless}}

            {{#each data.additionalFields as |field index|}}
            <tr>
              <th class="field-label {{#if field.show}}selected{{/if}}" data-type="additional" data-index="{{index}}">{{field.name}}</th>
              <td>
                <input
                  type="text"
                  class="additional-field-value"
                  data-index="{{index}}"
                  name="data.additionalFields.{{index}}.value"
                  value="{{field.value}}"
                />
              </td>
            </tr>
            {{/each}}
          </tbody>
        </table>

        <div class="os-help os-mt-6">
          Клик по названию поля переключает его видимость на листе персонажа. Если вписать в значение <b>-</b>, поле скрывается (его можно вернуть через кнопку <b>+ Поле</b>).
        </div>
      </section>
    </div>

    <!-- RIGHT COLUMN: details (Delivery / Summon / AoE) -->
    <div class="os-col">
      <section class="os-panel os-panel--pad">
        <h3 class="os-panel-title">Подробности</h3>

        <div class="os-form-grid">
          <div class="os-form-row">
            <label class="field-label {{#if (lookup data.displayFields 'DeliveryType')}}selected{{/if}}" data-field="DeliveryType">DeliveryType</label>
            <select name="data.DeliveryType" class="spell-delivery-select">
              {{#each spellDeliveryTypes as |opt|}}
                <option value="{{opt.value}}" {{isSelected ../data.DeliveryType opt.value}}>{{opt.label}}</option>
              {{/each}}
            </select>
          </div>

          <!-- SAVE-CHECK -->
          <div class="os-form-row spell-delivery-row spell-delivery-save-ability">
            <label class="field-label {{#if (lookup data.displayFields 'SaveAbility')}}selected{{/if}}" data-field="SaveAbility">SaveAbility</label>
            <select name="data.SaveAbility">
              <option value="" {{isSelected data.SaveAbility ""}}>—</option>
              {{#each characteristics as |c|}}
                <option value="{{c}}" {{isSelected ../data.SaveAbility c}}>{{c}}</option>
              {{/each}}
            </select>
          </div>

          <div class="os-form-row spell-delivery-row spell-delivery-formula">
            <label class="field-label {{#if (lookup data.displayFields 'SaveDCFormula')}}selected{{/if}}" data-field="SaveDCFormula">SaveDCFormula</label>
            <input type="text" name="data.SaveDCFormula" value="{{data.SaveDCFormula}}" placeholder="например: 10 + @Will" />
          </div>

          <!-- AOE / CREATE-OBJECT -->
          <div class="spell-delivery-row spell-delivery-aoe">
            <div class="os-subtitle">AoE / Template</div>
            <div class="os-form-grid os-form-grid--compact">
              <div class="os-form-row">
                <label class="field-label {{#if (lookup data.displayFields 'AreaShape')}}selected{{/if}}" data-field="AreaShape">Shape</label>
                <select name="data.AreaShape">
                  {{#each areaShapeTypes as |opt|}}
                    <option value="{{opt.value}}" {{isSelected ../data.AreaShape opt.value}}>{{opt.label}}</option>
                  {{/each}}
                </select>
              </div>

              <div class="os-form-row">
                <label class="field-label {{#if (lookup data.displayFields 'AreaSize')}}selected{{/if}}" data-field="AreaSize">Size</label>
                <input type="number" name="data.AreaSize" value="{{data.AreaSize}}" data-dtype="Number" min="0" step="0.5" />
              </div>

              <div class="os-form-row">
                <label class="field-label {{#if (lookup data.displayFields 'AreaWidth')}}selected{{/if}}" data-field="AreaWidth">Width</label>
                <input type="number" name="data.AreaWidth" value="{{data.AreaWidth}}" data-dtype="Number" min="0" step="0.5" />
              </div>

              <div class="os-form-row">
                <label class="field-label {{#if (lookup data.displayFields 'AreaAngle')}}selected{{/if}}" data-field="AreaAngle">Angle</label>
                <input type="number" name="data.AreaAngle" value="{{data.AreaAngle}}" data-dtype="Number" min="0" step="1" />
              </div>

              <div class="os-form-row">
                <label class="field-label {{#if (lookup data.displayFields 'AreaPersistent')}}selected{{/if}}" data-field="AreaPersistent">Persistent</label>
                <input type="checkbox" name="data.AreaPersistent" {{#if data.AreaPersistent}}checked{{/if}} />
              </div>

              <div class="os-form-row os-form-row--wide">
                <label class="field-label {{#if (lookup data.displayFields 'AreaColor')}}selected{{/if}}" data-field="AreaColor">Color</label>
                <div class="os-inline">
                  <select class="spell-area-color-preset">
                    <option value="">По цвету игрока</option>
                    <option value="#e6194b" {{isSelected data.AreaColor "#e6194b"}}>Preset: red</option>
                    <option value="#4363d8" {{isSelected data.AreaColor "#4363d8"}}>Preset: blue</option>
                    <option value="#42d4f4" {{isSelected data.AreaColor "#42d4f4"}}>Preset: cyan</option>
                    <option value="#ffffff" {{isSelected data.AreaColor "#ffffff"}}>Preset: white</option>
                    <option value="#000000" {{isSelected data.AreaColor "#000000"}}>Preset: black</option>
                    <option value="__custom__" {{#if data.AreaColor}}{{#unless (isPresetColor data.AreaColor)}}selected{{/unless}}{{/if}}>Кастом</option>
                  </select>
                  <input class="spell-area-color-input" type="color" value="{{#if data.AreaColor}}{{data.AreaColor}}{{else}}#ffffff{{/if}}" />
                  <input type="hidden" name="data.AreaColor" value="{{data.AreaColor}}" />
                </div>
              </div>
            </div>
          </div>

          <!-- SUMMON -->
          <div class="spell-delivery-row spell-delivery-summon">
            <div class="os-subtitle">Summon</div>
            <div class="os-form-grid os-form-grid--compact">
              <div class="os-form-row os-form-row--wide">
                <label class="field-label {{#if (lookup data.displayFields 'SummonActorUuid')}}selected{{/if}}" data-field="SummonActorUuid">Actor</label>
                <div class="os-inline">
                  <select class="summon-actor-pick">
                    <option value="">— выбрать из мира —</option>
                    {{#each summonActorOptions as |a|}}
                      <option value="{{a.uuid}}" {{isSelected ../data.SummonActorUuid a.uuid}}>{{a.name}}</option>
                    {{/each}}
                  </select>
                  <input type="text" name="data.SummonActorUuid" value="{{data.SummonActorUuid}}" placeholder="Actor.UUID" />
                </div>
              </div>

              <div class="os-form-row">
                <label class="field-label {{#if (lookup data.displayFields 'SummonCount')}}selected{{/if}}" data-field="SummonCount">Count</label>
                <input type="number" name="data.SummonCount" value="{{data.SummonCount}}" data-dtype="Number" min="1" />
              </div>

              <div class="os-form-row">
                <label class="field-label {{#if (lookup data.displayFields 'SummonDisposition')}}selected{{/if}}" data-field="SummonDisposition">Disposition</label>
                <select name="data.SummonDisposition">
                  <option value="same-as-caster" {{isSelected data.SummonDisposition "same-as-caster"}}>как у кастера</option>
                  <option value="friendly" {{isSelected data.SummonDisposition "friendly"}}>friendly</option>
                  <option value="neutral" {{isSelected data.SummonDisposition "neutral"}}>neutral</option>
                  <option value="hostile" {{isSelected data.SummonDisposition "hostile"}}>hostile</option>
                </select>
              </div>

              <div class="os-form-row">
                <label class="field-label {{#if (lookup data.displayFields 'SummonDeleteOnExpiry')}}selected{{/if}}" data-field="SummonDeleteOnExpiry">Delete on expiry</label>
                <input type="checkbox" name="data.SummonDeleteOnExpiry" {{#if data.SummonDeleteOnExpiry}}checked{{/if}} />
              </div>
            </div>
          </div>
        </div>

        <div class="os-help os-mt-6">
          DeliveryType управляет дополнительными блоками ниже. Секции скрываются автоматически.
        </div>
      </section>
    </div>

    <!-- FULL WIDTH: effects editor -->
    <div class="os-row-span">
      <section class="os-panel os-panel--pad">
        <div class="os-panel-title-row">
          <h3 class="os-panel-title">Эффекты заклинания</h3>
          <button type="button" class="effect-add os-small-btn">+ Эффект</button>
        </div>

        <div class="os-effects-list">
          {{#if spellEffects}}
          {{#each spellEffects as |ef idx|}}
            <div class="effect-row" data-effect-index="{{idx}}" data-effect-type="{{ef.type}}">
              <select class="effect-type" data-effect-index="{{idx}}">
                <option value="text" {{isSelected ef.type "text"}}>text</option>
                <option value="debuff" {{isSelected ef.type "debuff"}}>debuff</option>
              </select>

              <input class="effect-text" data-effect-index="{{idx}}" type="text" value="{{ef.text}}" placeholder="текст эффекта" />

              <input class="effect-debuffKey" data-effect-index="{{idx}}" type="text" value="{{ef.debuffKey}}" placeholder="debuffKey" />

              <input class="effect-stage" data-effect-index="{{idx}}" type="number" min="1" step="1" value="{{ef.stage}}" title="Стадия" />

              <button type="button" class="effect-remove os-small-btn" data-effect-index="{{idx}}">Удалить</button>
            </div>
          {{/each}}

          {{else}}
            <div class="os-empty">Нет эффектов</div>
          {{/if}}
        </div>
      </section>
    </div>
  </div>
</form>
