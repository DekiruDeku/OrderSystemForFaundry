<form class="{{cssClass}} spell os-item-form {{#unless osCanEdit}}os-edit-locked{{/unless}}" autocomplete="off">
  <header class="sheet-header os-item-header">
    <img class="os-item-img" src="{{item.img}}" data-edit="img" title="{{item.name}}" />

    <div class="os-item-headmeta">
      <h1 class="os-item-title">
        <input name="name" type="text" value="{{item.name}}" placeholder="{{ localize 'Name' }}" />
      </h1>
      <div class="os-item-subtitle">Заклинание</div>
    </div>
  </header>

  <!-- Variant B: right = Details (Delivery / Summon / AoE), effects = bottom -->
  <div class="os-item-body os-item-grid os-item-grid--spell">
    <!-- LEFT COLUMN: main fields -->
    <div class="os-col">
      <section class="os-panel os-panel--pad">
        <div class="os-panel-title-row">
          <h3 class="os-panel-title">Основное</h3>
          <div class="os-inline">
            <button type="button" class="train-item-sheet os-small-btn" title="Тренировка">
              <i class="fas fa-book"></i> Тренировка
            </button>
            {{#if osCanEdit}}<button type="button" class="add-field os-small-btn">+ Поле</button>{{/if}}
          </div>
        </div>

        <table class="fields-table os-fields-table">
          <tbody>
            {{#unless data.hiddenDefaults.Circle}}
            <tr>
              <th class="field-label {{#if (lookup data.displayFields 'Circle')}}selected{{/if}}" data-field="Circle">Круг</th>
              <td><input type="text" inputmode="numeric" name="data.Circle" value="{{data.Circle}}" data-dtype="Number" min="0" max="12" /></td>
            </tr>
            {{/unless}}

            {{#unless data.hiddenDefaults.Level}}
            <tr>
              <th class="field-label {{#if (lookup data.displayFields 'Level')}}selected{{/if}}" data-field="Level">Уровень</th>
              <td><input type="text" inputmode="numeric" name="data.Level" value="{{data.Level}}" data-dtype="Number" min="0" /></td>
            </tr>
            {{/unless}}

            {{#unless data.hiddenDefaults.DamageFormula}}
            <tr>
            <th class="field-label {{#if (lookup data.displayFields 'DamageFormula')}}selected{{/if}}" data-field="DamageFormula">
              Формула воздействия
            </th>
            <td>
              <input type="text" name="data.DamageFormula" value="{{data.DamageFormula}}"
              placeholder="например: 5 + Strength * 2" />
            <div style="font-size:12px; opacity:0.8; margin-top:4px;">
              Формат: <code>число + характеристика * множитель</code>. Поддерживаются RU/EN названия характеристик.
            </div>
            </td>
            </tr>
            {{/unless}}
            {{#unless data.hiddenDefaults.Damage}}
            <tr>
            <th class="field-label {{#if (lookup data.displayFields 'Damage')}}selected{{/if}}" data-field="Damage">Воздействие
            </th>
            <td>
            <div style="display:flex; gap:8px; align-items:center;">
              <select name="data.DamageMode" data-type="String" style="max-width:140px;">
                <option value="damage" {{isSelected data.DamageMode "damage" }}>Урон</option>
                <option value="heal" {{isSelected data.DamageMode "heal" }}>Лечение</option>
              </select>
              <input type="text" inputmode="numeric" name="data.Damage" value="{{data.Damage}}" data-dtype="Number" min="0"
              readonly />
            </div>
            </td>
            </tr>
            {{/unless}}

            {{#unless data.hiddenDefaults.Multiplier}}
            <tr>
              <th class="field-label {{#if (lookup data.displayFields 'Multiplier')}}selected{{/if}}" data-field="Multiplier">Множитель</th>
              <td><input type="text" inputmode="numeric" name="data.Multiplier" value="{{data.Multiplier}}" data-dtype="Number" min="0" step="0.1" /></td>
            </tr>
            {{/unless}}

            {{#unless data.hiddenDefaults.RangeFormula}}
            <tr>
              <th class="field-label {{#if (lookup data.displayFields 'RangeFormula')}}selected{{/if}}" data-field="RangeFormula">Формула дальности</th>
              <td>
                <input type="text" name="data.RangeFormula" value="{{data.RangeFormula}}" placeholder="например: 5 + Magic" />
                <div style="font-size:12px; opacity:0.8; margin-top:4px;">
                  Формат: <code>число + характеристика * множитель</code>. Поддерживаются RU/EN названия характеристик.
                </div>
              </td>
            </tr>
            {{/unless}}

            {{#unless data.hiddenDefaults.Range}}
            <tr>
              <th class="field-label {{#if (lookup data.displayFields 'Range')}}selected{{/if}}" data-field="Range">Дистанция</th>
              <td><input type="text" inputmode="numeric" name="data.Range" value="{{data.Range}}" data-dtype="Number" min="0" readonly /></td>
            </tr>
            {{/unless}}

            {{#unless data.hiddenDefaults.Duration}}
            <tr>
              <th class="field-label {{#if (lookup data.displayFields 'Duration')}}selected{{/if}}" data-field="Duration">Длительность</th>
              <td><input type="text" name="data.Duration" value="{{data.Duration}}" /></td>
            </tr>
            {{/unless}}

            {{#unless data.hiddenDefaults.UsageCost}}
            <tr>
              <th class="field-label {{#if (lookup data.displayFields 'UsageCost')}}selected{{/if}}" data-field="UsageCost">Стоимость применения</th>
              <td><input type="text" inputmode="numeric" name="data.UsageCost" value="{{data.UsageCost}}" data-dtype="Number" placeholder="например: 2" /></td>
            </tr>
            {{/unless}}

            {{#unless data.hiddenDefaults.ActionCost}}
            <tr>
              <th class="field-label {{#if (lookup data.displayFields 'ActionCost')}}selected{{/if}}" data-field="ActionCost">Стоимость действий</th>
              <td><input type="text" name="data.ActionCost" value="{{data.ActionCost}}" placeholder="например: 1 действие" /></td>
            </tr>
            {{/unless}}

            {{#unless data.hiddenDefaults.UsageThreshold}}
            <tr>
              <th class="field-label {{#if (lookup data.displayFields 'UsageThreshold')}}selected{{/if}}" data-field="UsageThreshold">Порог условия применения</th>
              <td class="os-inline">
                <input type="text" inputmode="numeric" name="data.UsageThreshold" value="{{data.UsageThreshold}}" data-dtype="Number" min="0" />
              </td>
            </tr>
            {{/unless}}

            {{#unless data.hiddenDefaults.RollFormulas}}
            <tr>
              <th class="field-label {{#if (lookup data.displayFields 'RollFormulas')}}selected{{/if}}" data-field="RollFormulas">Формулы броска</th>
              <td>
                <div>
                  {{#if data.RollFormulas.length}}
                    {{#each data.RollFormulas as |f idx|}}
                      <div class="os-inline" style="gap:6px; margin-bottom:6px;">
                        <input
                          type="text"
                          class="roll-formula-value"
                          data-index="{{idx}}"
                          name="data.RollFormulas.{{idx}}"
                          value="{{f}}"
                          placeholder="например: Magic + 2"
                        />
                        {{#if @root.osCanEdit}}<button type="button" class="roll-formula-remove os-small-btn" data-index="{{idx}}">Удалить</button>{{/if}}
                      </div>
                    {{/each}}
                  {{else}}
                    <div class="os-empty">Нет формул</div>
                  {{/if}}
                  {{#if osCanEdit}}<button type="button" class="roll-formula-add os-small-btn">+ Формула</button>{{/if}}
                  <div style="font-size:12px; opacity:0.8; margin-top:4px;">
                    Если не указано — используется <code>Magic</code> (с модификаторами). Поддерживаются RU/EN названия характеристик.
                  </div>
                </div>
              </td>
            </tr>
            {{/unless}}

            {{#unless data.hiddenDefaults.Description}}
            <tr>
              <th class="field-label {{#if (lookup data.displayFields 'Description')}}selected{{/if}}" data-field="Description">Описание</th>
              <td><textarea name="data.Description">{{data.Description}}</textarea></td>
            </tr>
            {{/unless}}

            {{#each data.additionalFields as |field index|}}
            {{#unless field.hidden}}
            <tr>
              <th class="field-label {{#if field.show}}selected{{/if}}" data-type="additional" data-index="{{index}}">{{field.name}}</th>
              <td>
                <input
                  type="text"
                  class="additional-field-value"
                  data-index="{{index}}"
                  name="data.additionalFields.{{index}}.value"
                  value="{{field.value}}"
                />
              </td>
            </tr>
            {{/unless}}
            {{/each}}
          </tbody>
        </table>

        <div class="os-help os-mt-6">
          Клик по названию поля переключает его видимость на листе персонажа. Если вписать в значение <b>-</b>, поле скрывается (его можно вернуть через кнопку <b>+ Поле</b>).
        </div>
      </section>
    </div>

    <!-- RIGHT COLUMN: details (Delivery / Summon / AoE) -->
    <div class="os-col">
      <section class="os-panel os-panel--pad os-skill-circle-panel">
        <h3 class="os-panel-title">Прогресс обучения</h3>
        <div class="os-center">
          <canvas
            class="circle-progress-skill"
            data-circle="{{data.Circle}}"
            data-level="{{data.Level}}"
            data-filled="{{data.filledSegments}}"
          ></canvas>
        </div>
        <div class="os-help os-mt-6">
          ЛКМ: +1 очко обучения. ПКМ: -1 очко обучения. При заполнении круга уровень повышается.
        </div>
      </section>
{{#if osCanEdit}}

      <section class="os-panel os-panel--pad">
        <h3 class="os-panel-title">Подробности</h3>

        <div class="os-form-grid">
          <div class="os-form-row">
            <label class="field-label {{#if (lookup data.displayFields 'DeliveryType')}}selected{{/if}}" data-field="DeliveryType">Тип применения</label>
            <select name="data.DeliveryType" class="spell-delivery-select">
              {{#each spellDeliveryTypes as |opt|}}
                <option value="{{opt.value}}" {{isSelected ../data.DeliveryType opt.value}}>{{opt.label}}</option>
              {{/each}}
            </select>
          </div>

          <div class="os-form-row">
            <label class="field-label {{#if (lookup data.displayFields 'DeliveryPipeline')}}selected{{/if}}" data-field="DeliveryPipeline">Второй тип применения</label>
            <select name="data.DeliveryPipeline" class="spell-delivery-pipeline">
              {{#each spellPipelineTypes as |opt|}}
                <option value="{{opt.value}}" {{isSelected ../data.DeliveryPipeline opt.value}}>{{opt.label}}</option>
              {{/each}}
            </select>
          </div>

          {{#unless data.hiddenDefaults.EffectThreshold}}
          <div class="os-form-row spell-delivery-row spell-delivery-attack">
            <label class="field-label {{#if (lookup data.displayFields 'EffectThreshold')}}selected{{/if}}" data-field="EffectThreshold">Порог эффекта</label>
            <input type="text" inputmode="numeric" name="data.EffectThreshold" value="{{data.EffectThreshold}}" data-dtype="Number" min="0" />
          </div>
          {{/unless}}

          <!-- SAVE-CHECK -->
          {{#unless data.hiddenDefaults.SaveAbility}}
          <div class="os-form-row spell-delivery-row spell-delivery-save-ability">
            <label class="field-label {{#if (lookup data.displayFields 'SaveAbility')}}selected{{/if}}" data-field="SaveAbility">Проверка цели (характеристика)</label>
            <select name="data.SaveAbility">
              <option value="" {{isSelected data.SaveAbility ""}}>—</option>
              {{#each characteristics as |c|}}
                <option value="{{c}}" {{isSelected ../data.SaveAbility c}}>{{localize c}}</option>
              {{/each}}
            </select>
          </div>
          {{/unless}}

          {{#unless data.hiddenDefaults.SaveDCFormula}}
          <div class="os-form-row spell-delivery-row spell-delivery-formula">
            <label class="field-label {{#if (lookup data.displayFields 'SaveDCFormula')}}selected{{/if}}" data-field="SaveDCFormula">Сложность проверки (КС)</label>
            <input type="text" name="data.SaveDCFormula" value="{{data.SaveDCFormula}}" placeholder="например: 10 + @Will" />
          </div>
          {{/unless}}

          <!-- AOE / CREATE-OBJECT -->
          <div class="spell-delivery-row spell-delivery-aoe">
            <div class="os-subtitle">Область / Шаблон</div>
            <div class="os-form-grid os-form-grid--compact">
              {{#unless data.hiddenDefaults.AreaShape}}
              <div class="os-form-row">
                <label class="field-label {{#if (lookup data.displayFields 'AreaShape')}}selected{{/if}}" data-field="AreaShape">Форма</label>
                <select name="data.AreaShape">
                  {{#if (eq data.DeliveryType "create-object")}}
                    {{#each spellCreateObjectShapeTypes as |opt|}}
                      <option value="{{opt.value}}" {{isSelected ../data.AreaShape opt.value}}>{{opt.label}}</option>
                    {{/each}}
                  {{else}}
                    {{#each spellAoeTemplateShapeTypes as |opt|}}
                      <option value="{{opt.value}}" {{isSelected ../data.AreaShape opt.value}}>{{opt.label}}</option>
                    {{/each}}
                  {{/if}}
                </select>
              </div>
              {{/unless}}

              {{#unless data.hiddenDefaults.AreaSize}}
              <div class="os-form-row">
                <label class="field-label {{#if (lookup data.displayFields 'AreaSize')}}selected{{/if}}" data-field="AreaSize">Размер</label>
                <input type="text" inputmode="numeric" name="data.AreaSize" value="{{data.AreaSize}}" data-dtype="Number" min="0" step="0.5" />
              </div>
              {{/unless}}

              {{#unless data.hiddenDefaults.AreaWidth}}
              <div class="os-form-row">
                <label class="field-label {{#if (lookup data.displayFields 'AreaWidth')}}selected{{/if}}" data-field="AreaWidth">Ширина</label>
                <input type="text" inputmode="numeric" name="data.AreaWidth" value="{{data.AreaWidth}}" data-dtype="Number" min="0" step="0.5" />
              </div>
              {{/unless}}

              {{#unless data.hiddenDefaults.AreaAngle}}
              <div class="os-form-row">
                <label class="field-label {{#if (lookup data.displayFields 'AreaAngle')}}selected{{/if}}" data-field="AreaAngle">Угол</label>
                <input type="text" inputmode="numeric" name="data.AreaAngle" value="{{data.AreaAngle}}" data-dtype="Number" min="0" step="1" />
              </div>
              {{/unless}}

              {{#unless data.hiddenDefaults.AreaPersistent}}
              <div class="os-form-row">
                <label class="field-label {{#if (lookup data.displayFields 'AreaPersistent')}}selected{{/if}}" data-field="AreaPersistent">Постоянная</label>
                <input type="checkbox" name="data.AreaPersistent" {{#if data.AreaPersistent}}checked{{/if}} />
              </div>
              {{/unless}}

              {{#unless data.hiddenDefaults.AreaColor}}
              <div class="os-form-row os-form-row--wide">
                <label class="field-label {{#if (lookup data.displayFields 'AreaColor')}}selected{{/if}}" data-field="AreaColor">Цвет</label>
                <div class="os-inline">
                  <select class="spell-area-color-preset">
                    <option value="">По цвету игрока</option>
                    <option value="#e6194b" {{isSelected data.AreaColor "#e6194b"}}>Пресет: красный</option>
                    <option value="#4363d8" {{isSelected data.AreaColor "#4363d8"}}>Пресет: синий</option>
                    <option value="#42d4f4" {{isSelected data.AreaColor "#42d4f4"}}>Пресет: голубой</option>
                    <option value="#ffffff" {{isSelected data.AreaColor "#ffffff"}}>Пресет: белый</option>
                    <option value="#000000" {{isSelected data.AreaColor "#000000"}}>Пресет: чёрный</option>
                    <option value="__custom__" {{#if data.AreaColor}}{{#unless (isPresetColor data.AreaColor)}}selected{{/unless}}{{/if}}>Свой</option>
                  </select>
                  <input class="spell-area-color-input" type="color" value="{{#if data.AreaColor}}{{data.AreaColor}}{{else}}#ffffff{{/if}}" />
                  <input type="hidden" name="data.AreaColor" value="{{data.AreaColor}}" />
                </div>
              </div>
              {{/unless}}
            </div>
          </div>

          <!-- SUMMON -->
          <div class="spell-delivery-row spell-delivery-summon">
            <div class="os-subtitle">Призыв</div>
            <div class="os-form-grid os-form-grid--compact">
              {{#unless data.hiddenDefaults.SummonActorUuid}}
              <div class="os-form-row os-form-row--wide">
                <label class="field-label {{#if (lookup data.displayFields 'SummonActorUuid')}}selected{{/if}}" data-field="SummonActorUuid">Сущность</label>
                <div class="os-inline">
                  <select class="summon-actor-pick">
                    <option value="">— выбрать из мира —</option>
                    {{#each summonActorOptions as |a|}}
                      <option value="{{a.uuid}}" {{isSelected ../data.SummonActorUuid a.uuid}}>{{a.name}}</option>
                    {{/each}}
                  </select>
                  <input type="text" name="data.SummonActorUuid" value="{{data.SummonActorUuid}}" placeholder="UUID актёра" />
                </div>
              </div>
              {{/unless}}

              {{#unless data.hiddenDefaults.SummonCount}}
              <div class="os-form-row">
                <label class="field-label {{#if (lookup data.displayFields 'SummonCount')}}selected{{/if}}" data-field="SummonCount">Количество</label>
                <input type="text" inputmode="numeric" name="data.SummonCount" value="{{data.SummonCount}}" data-dtype="Number" min="1" />
              </div>
              {{/unless}}

              {{#unless data.hiddenDefaults.SummonDisposition}}
              <div class="os-form-row">
                <label class="field-label {{#if (lookup data.displayFields 'SummonDisposition')}}selected{{/if}}" data-field="SummonDisposition">Отношение</label>
                <select name="data.SummonDisposition">
                  <option value="same-as-caster" {{isSelected data.SummonDisposition "same-as-caster"}}>как у кастера</option>
                  <option value="friendly" {{isSelected data.SummonDisposition "friendly"}}>дружественный</option>
                  <option value="neutral" {{isSelected data.SummonDisposition "neutral"}}>нейтральный</option>
                  <option value="hostile" {{isSelected data.SummonDisposition "hostile"}}>враждебный</option>
                </select>
              </div>
              {{/unless}}

              {{#unless data.hiddenDefaults.SummonDeleteOnExpiry}}
              <div class="os-form-row">
                <label class="field-label {{#if (lookup data.displayFields 'SummonDeleteOnExpiry')}}selected{{/if}}" data-field="SummonDeleteOnExpiry">Удалять по окончании</label>
                <input type="checkbox" name="data.SummonDeleteOnExpiry" {{#if data.SummonDeleteOnExpiry}}checked{{/if}} />
              </div>
              {{/unless}}
            </div>
          </div>
        </div>

        <div class="os-help os-mt-6">
          Тип применения управляет дополнительными блоками ниже. Секции скрываются автоматически.
        </div>
      </section>
{{/if}}

    </div>

    <!-- FULL WIDTH: effects editor -->
    <div class="os-row-span">
      <section class="os-panel os-panel--pad">
        <div class="os-panel-title-row">
          <h3 class="os-panel-title">Эффекты заклинания</h3>
          {{#if osCanEdit}}<button type="button" class="effect-add os-small-btn">+ Эффект</button>{{/if}}
        </div>

        <div class="os-effects-list">
          {{#if spellEffects}}
          {{#each spellEffects as |ef idx|}}
            <div class="effect-row" data-effect-index="{{idx}}" data-effect-type="{{ef.type}}">
              <select class="effect-type" data-effect-index="{{idx}}">
                <option value="text" {{isSelected ef.type "text"}}>текст</option>
                <option value="debuff" {{isSelected ef.type "debuff"}}>дебафф</option>
                <option value="buff" {{isSelected ef.type "buff"}}>бафф</option>
              </select>

              <input class="effect-text" data-effect-index="{{idx}}" type="text" value="{{ef.text}}" placeholder="текст эффекта" style="{{#if (eq ef.type "text")}}display:block;{{else}}display:none;{{/if}}" />

              <select class="effect-debuffKey os-select" data-effect-index="{{idx}}" style="min-width:180px; {{#if (eq ef.type "debuff")}}display:block;{{else}}display:none;{{/if}}">
                <option value="">— выберите дебафф —</option>
                {{#each ../debuffOptions as |opt|}}
                  <option value="{{opt.key}}" {{isSelected opt.key ef.debuffKey}}>{{opt.label}}</option>
                {{/each}}
              </select>

              <select class="effect-stage os-select" data-effect-index="{{idx}}" title="Стадия" style="width:88px; {{#if (eq ef.type "debuff")}}display:block;{{else}}display:none;{{/if}}">
                <option value="1" {{isSelected ef.stage 1}}>1</option>
                <option value="2" {{isSelected ef.stage 2}}>2</option>
                <option value="3" {{isSelected ef.stage 3}}>3</option>
              </select>

              {{#if @root.osCanEdit}}<button type="button" class="effect-remove os-small-btn" data-effect-index="{{idx}}">Удалить</button>{{/if}}
            </div>
          {{/each}}

          {{else}}
            <div class="os-empty">Нет эффектов</div>
          {{/if}}
        </div>
      </section>
    </div>
  </div>
</form>
