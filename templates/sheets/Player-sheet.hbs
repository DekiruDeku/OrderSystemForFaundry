<form class="{{cssClass}} order-sheet" autocomplete="off">
  <div class="os-sheet">

    <!-- LEFT: side menu (Biography / Inventory / Equipment / Skills) -->
    <aside class="os-left">
      <div class="os-panel os-panel-left os-side-menu">
        <nav class="tabs_side-menu os-tabs os-left-tabs">
          <a class="navbar" data-tab="biography">Биография</a>
          <a class="navbar" data-tab="inventory">Инвентарь</a>
          <a class="navbar" data-tab="equipment">Снаряжение</a>
          <a class="navbar" data-tab="skills">Способности</a>
        </nav>

        <div class="tab-content os-left-content">
          <div id="biography" class="tab-bar os-left-tab">
            {{> "systems/Order/templates/partials/biography.hbs"}}
          </div>
          <div id="inventory" class="tab-bar os-left-tab">
            {{> "systems/Order/templates/partials/inventory.hbs"}}
          </div>
          <div id="equipment" class="tab-bar os-left-tab">
            {{> "systems/Order/templates/partials/equipment.hbs"}}
          </div>
          <div id="skills" class="tab-bar os-left-tab">
            {{> "systems/Order/templates/partials/skills.hbs"}}
          </div>
        </div>
      </div>
    </aside>

    <!-- CENTER: Name (centered) + (Resources left / Portrait center / Meta right) + Effects -->
    <main class="os-center">
      <section class="os-top">
        <div class="os-top-spacer"></div>
        <div class="os-namebar os-namebar-centered">
          <input class="os-name os-name-compact" name="name" type="text" value="{{actor.name}}" placeholder="Имя персонажа" />
        </div>
        <div class="os-top-spacer"></div>
      </section>
      <section class="os-mid">
        <!-- Left: resources (HP / Mana / Stress) as separate panels -->
        <div class="os-mid-left">
          <!-- HP -->
          <div class="os-panel os-resource os-resource-hp" style="--bar-color: var(--os-red)">
            <div class="os-resource-header">
              <span class="os-resource-label">HP</span>
            </div>
            <div class="os-bar">
              <div class="os-bar-fill" style="width: {{barPct data.Health.value data.Health.max}}%;"></div>
            </div>
            <div class="os-resource-values">
              <input name="data.Health.value" type="text" value="{{data.Health.value}}" data-dtype="Number" />
              <span class="os-split">/</span>
              <input name="data.Health.max" type="text" value="{{data.Health.max}}" data-dtype="Number" readonly />
            </div>
          </div>

          <!-- Mana Fatigue -->
          <div class="os-panel os-resource os-resource-mana" style="--bar-color: var(--os-blue)">
            <div class="os-resource-header">
              <span class="os-resource-label">Магическая усталость</span>
            </div>
            <div class="os-bar">
              <div class="os-bar-fill" style="width: {{barPct data.ManaFatigue.value data.ManaFatigue.max}}%;"></div>
            </div>
            <div class="os-resource-values">
              <input name="data.ManaFatigue.value" type="text" value="{{data.ManaFatigue.value}}" data-dtype="Number" />
              <span class="os-split">/</span>
              <input name="data.ManaFatigue.max" type="text" value="{{data.ManaFatigue.max}}" data-dtype="Number" readonly />
            </div>
          </div>

          <!-- Stress -->
          <div class="os-panel os-resource os-resource-stress" style="--bar-color: var(--os-gray)">
            <div class="os-resource-header">
              <span class="os-resource-label">Стресс</span>
            </div>
            <div class="os-bar">
              <div class="os-bar-fill" style="width: {{barPct data.Stress.value data.Stress.max}}%;"></div>
            </div>
            <div class="os-resource-values">
              <input name="data.Stress.value" type="text" value="{{data.Stress.value}}" data-dtype="Number" />
              <span class="os-split">/</span>
              <input name="data.Stress.max" type="text" value="{{data.Stress.max}}" data-dtype="Number" readonly />
            </div>
          </div>
        </div>

        <!-- Center: portrait -->
        <div class="os-panel os-portrait">
          <img class="os-portrait-img" src="{{actor.img}}" data-edit="img" title="{{actor.name}}" />
        </div>

        <!-- Right: Rank / Class / Speed as separate panels -->
        <div class="os-mid-right">
          <!-- Rank -->
          <div class="os-panel os-meta-panel os-meta-panel-rank">
            <div class="os-meta-row">
              <label class="os-meta-label" for="rank">Ранг</label>
              <input class="os-meta-input" name="data.Rank" type="text" value="{{data.Rank}}" data-dtype="Number" />
            </div>
          </div>

          <!-- Class -->
          <div class="os-panel os-meta-panel os-meta-panel-class">
            <div class="os-meta-block">
              <div class="os-meta-label">Класс</div>
              <div class="os-meta-scroll">
                <section class="ClassSection">
                  {{#each Classes as |class|}}
                  {{> "systems/Order/templates/partials/class-card.hbs" class}}
                  {{/each}}
                </section>
              </div>
            </div>
          </div>

          <!-- Speed -->
          <div class="os-panel os-meta-panel os-meta-panel-speed">
            <div class="os-meta-block">
              <div class="os-meta-label">Скорость</div>
              <div class="os-resource os-resource-move os-resource-inline">
                <div class="os-resource-values os-resource-values-inline">
                  <input name="data.Movement.value" type="text" value="{{data.Movement.value}}" data-dtype="Number" readonly />

                  <div class="modifiers-wrapper">
                    <span class="modifiers-total">{{sumModifiers data.Movement.modifiers}}</span>
                    <div class="modifiers-tooltip">
                      {{#if (gt (length data.Movement.modifiers) 0)}}
                      <ul>
                        {{#each data.Movement.modifiers}}
                        <li><strong>{{this.effectName}}</strong>: {{this.value}}{{#if this.source}} ({{this.source}}) {{/if}}</li>
                        {{/each}}
                      </ul>
                      {{else}}
                      <p>Нет модификаторов</p>
                      {{/if}}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>


      <section class="os-bottom">
        <div class="os-panel os-effects">
          <div class="os-effects-header">
            <div class="os-effects-title">Активные эффекты</div>
            <button class="apply-debuff os-btn os-btn-accent os-btn-sm" type="button">+ Дебафф</button>
          </div>

          <div class="active-effects os-effects-list">
            <ul>
              {{#each effects}}
              <li class="effect-item" data-effect-id="{{this._id}}">
                <div class="effect-icon">
                  <img src="{{this.icon}}" alt="{{this.name}}" title="{{this.name}}" width="32" height="32">
                </div>

                <div class="effect-details">
                  <strong>{{this.name}}</strong>
                  <p>{{this.flags.description}}</p>

                  {{#if this.flags.Order}}
                  <div class="effect-level-controls">
                    <button class="effect-level-decrease os-btn os-btn-ghost" type="button" aria-label="Понизить уровень дебаффа">-</button>
                    <span class="effect-level-display">{{this.flags.Order.stateKey}}</span>
                    <button class="effect-level-increase os-btn os-btn-ghost" type="button" aria-label="Повысить уровень дебаффа">+</button>
                  </div>
                  {{/if}}

                  <button class="remove-effect os-btn os-btn-ghost" type="button" data-effect-id="{{this._id}}">Удалить</button>
                </div>
              </li>
              {{/each}}
            </ul>
          </div>
        </div>
      </section>
    </main>

    <!-- RIGHT: Characteristics -->
    <aside class="os-right">
      <div class="os-panel os-panel-right">
        {{> "systems/Order/templates/partials/character-stat-block.hbs"}}
      </div>
    </aside>
  </div>

  <script src="systems/Order/scripts/debuff-script.js"></script>
</form>
